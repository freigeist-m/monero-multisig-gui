name: Build macOS App

on:
  push:
    branches: [ main, master ]  # adjust to your main branch name
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # allows manual trigger

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive  # important for the monero submodule
    
    - name: Install dependencies
      run: |
        # Install Monero dependencies
        brew install autoconf autogen automake binutils coreutils cmake pkg-config boost openssl hidapi zmq libpgm unbound libsodium miniupnpc readline expat ccache doxygen graphviz libunwind-headers xz protobuf libusb
        # Install Qt
        brew install qt@6
        echo 'export PATH="/opt/homebrew/opt/qt@6/bin:$PATH"' >> $GITHUB_ENV
    
    - name: Configure CMake
      run: |
        export PKG_CONFIG_PATH="/opt/homebrew/opt/libsodium/lib/pkgconfig:$PKG_CONFIG_PATH"
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release \
                 -DCMAKE_PREFIX_PATH=/opt/homebrew/opt/qt@6
    
    - name: Build
      run: |
        cd build
        cmake --build . --config Release -j$(sysctl -n hw.ncpu)
    
    - name: Bundle Qt dependencies
      run: |
        cd build
        /opt/homebrew/opt/qt@6/bin/macdeployqt appmonero-multisig-gui.app -qmldir=../qml
    
    - name: Create DMG (optional)
      run: |
        cd build
        # Simple DMG creation
        hdiutil create -volname "Monero Multisig" -srcfolder appmonero-multisig-gui.app -ov -format UDZO monero-multisig-gui.dmg
    
    - name: Upload .app bundle
      uses: actions/upload-artifact@v4
      with:
        name: monero-multisig-gui-macos
        path: build/appmonero-multisig-gui.app
    
    - name: Upload DMG
      uses: actions/upload-artifact@v4
      with:
        name: monero-multisig-gui-dmg
        path: build/monero-multisig-gui.dmg
